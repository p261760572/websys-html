<!doctype html>
<html><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="renderer" content="webkit">
    <title>影印件</title>
    <link rel="stylesheet" type="text/css" href="../../js/themes/default/xui.css">
    <link rel="stylesheet" type="text/css" href="../../js/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="../../css/uploadify.css">
    <link rel="stylesheet" type="text/css" href="../../css/tool.css">
    <style>
    	.uploadify-button {
			background-color: #eeeeee;
			background-image: linear-gradient(bottom, #eeeeee 0%, #ffffff 100%);
			background-image: -o-linear-gradient(bottom, #eeeeee 0%, #ffffff 100%);
			background-image: -moz-linear-gradient(bottom, #eeeeee 0%, #ffffff 100%);
			background-image: -webkit-linear-gradient(bottom, #eeeeee 0%, #ffffff 100%);
			background-image: -ms-linear-gradient(bottom, #eeeeee 0%, #ffffff 100%);
			background-repeat: no-repeat;
			-webkit-border-radius: 5px;
			-moz-border-radius: 5px;
			border-radius: 5px;
			border: 1px solid #bbb;
			color: #444;
			font: normal 12px Verdana, Geneva, sans-serif;;
			text-align: center;
			text-shadow: 0 -1px 0 rgba(0,0,0,0.25);
			width: 100%;
		}
		.uploadify:hover .uploadify-button {
			background: #eaf2ff;
			color: #000000;
			border: 1px solid #b7d2ff;
			filter: none;
		}
    </style>
    <script type="text/javascript" src="../../js/js.cookie.js"></script>
    <script type="text/javascript" src="../../js/jquery.min.js"></script>
    <script type="text/javascript" src="../../js/jquery.xui.min.js"></script>
    <script type="text/javascript" src="../../js/jquery.uploadify.min.js"></script>
    <script type="text/javascript" src="../../js/jquery.xconfig.js"></script>
    <script type="text/javascript" src="../../js/jquery.tool.js"></script>
</head>

<body>
	<div id="upload-div">
		<div class="xui-tabs tabs"><div class="tabs-header"><ul class="tabs-nav"><li class="tabs-selected">上传影印件</li><li>自动上传影印件</li></ul></div><div class="tabs-panels" style="width:950px;">  
			<div style="Padding:5px;" class="tabs-panel">   
		        <form id="detail-fm" class="form add-form" action="/action/ms/photo-copy/view" method="post" style="width:938px;">
		                <table class="table" style="width:100%;">
		                	<tbody><tr>
		                	  <td class="right td20"><label>业务类型：</label></td>
		                	  <td class="td30 clear-readonly"><span class="xui-combobox combobox" data-options="panelHeight:'auto',editable:false,required:true,data:xConfig['apptype']"><input type="text" class="combobox-text"><input type="hidden" name="apptype" class="combobox-value"><span class="combobox-addon"><i class="combobox-icon combobox-arrow"></i></span></span>
		                	    <label class="required">*</label></td>
		                	  <td class="right td20"><label>影印件类型：</label></td>
		                	  <td class="td30 clear-readonly"><span class="xui-combobox combobox" data-options="editable:false,required:true,data:xConfig['copy_type']"><input type="text" class="combobox-text"><input type="hidden" name="copy_type" class="combobox-value"><span class="combobox-addon"><i class="combobox-icon combobox-arrow"></i></span></span>
		                	    <label class="required">*</label></td>
		                    </tr>
		                    <tr>
		                	  <td class="right td20"> 
		                	  <label>上传文件：</label>
		                	  </td>
		                	  <td colspan="2">
		                	  <div id="file_upload" class="uploadify" style="height: 30px; width: 120px;"><div id="file_upload-button" class="uploadify-button " style="height: 30px; line-height: 30px; width: 120px;"><span class="uploadify-button-text">浏览...</span></div></div><div id="file_upload-queue" class="uploadify-queue"></div>
		                	  </td>
		                	  <td>
		                	  	<a href="javascript:void(0)" class="xui-linkbutton l-btn" data-options="iconCls:'icon-upload'" style="padding:0 5px;" onclick="onClickUpload()"><span class="l-btn-left l-btn-icon-left"><span class="l-btn-text">上传</span><span class="l-btn-icon icon-upload">&nbsp;</span></span></a>
		                	  </td>
		                    </tr>
		                </tbody></table>      
		        </form>    
		    </div>    
		    <div style="padding: 5px; display: none;" class="tabs-panel">   
		        <form id="batch-detail-fm" class="form add-form" action="/action/ms/photo-copy/view" method="post" style="width:938px;">
		                <table class="table" style="table-layout:auto; width:100%;">
		                    <tbody><tr style="height:35px;">
		                      <td class="right td20"><label>说明：</label></td>
		                      <td colspan="2" class="td80"><label>自动上传影印件根据上传文件名确定业务类型和印影件类型，具体文件命名规则见文件</label>
	                          <a href="file_name_rules.txt" target="_blank">文件命名规则</a></td>
	                        </tr>
		                    <tr>
		                	  <td class="right td20"> 
		                	  <label>上传文件：</label>
		                	  </td>
		                	  <td class="td50">
		                	  <div id="batch_file_upload" class="uploadify" style="height: 30px; width: 120px;"><div id="batch_file_upload-button" class="uploadify-button " style="height: 30px; line-height: 30px; width: 120px;"><span class="uploadify-button-text">浏览...</span></div></div><div id="batch_file_upload-queue" class="uploadify-queue"></div>
		                	  </td>
		                	  <td class="td30">
		                	  	<a href="javascript:void(0)" class="xui-linkbutton l-btn" data-options="iconCls:'icon-upload'" style="padding:0 5px;" onclick="onClickBatchUpload()"><span class="l-btn-left l-btn-icon-left"><span class="l-btn-text">上传</span><span class="l-btn-icon icon-upload">&nbsp;</span></span></a>
		                	  </td>
		                    </tr>
		                </tbody></table>      
		        </form>
		    </div>    
		</div></div>
		<br>
		<br>
	</div>
	<div>
    <div>
        <form id="search-fm" class="form search-form" action="/action/ms/photo-copy/search" method="post" data-options="onSerialize:serializeSearchForm">
            <table class="table" style="width:950px;">
                <caption>查询影印件</caption>
                <tbody><tr>
		        <td class="right td20"><label>业务类型：</label></td>
		        <td class="td30"><span class="xui-combobox combobox" data-options="panelHeight:'auto',editable:false,data:xConfig['apptype']"><input type="text" class="combobox-text"><input type="hidden" name="apptype" class="combobox-value"><span class="combobox-addon"><i class="combobox-icon combobox-arrow"></i></span></span></td>
		        <td class="right td20"><label>影印件类型：</label></td>
		        <td class="td30"><span class="xui-combobox combobox" data-options="editable:false,data:xConfig['copy_type']"><input type="text" class="combobox-text"><input type="hidden" name="copy_type" class="combobox-value"><span class="combobox-addon"><i class="combobox-icon combobox-arrow"></i></span></span></td>
		        </tr>
                </tbody><tfoot>
                    <tr>
                        <td colspan="4" class="center">
                            <div style="margin:5px;"></div>
                            <a href="javascript:void(0)" id="search-btn" class="xui-linkbutton l-btn" data-options="iconCls:'icon-search',datagrid:'#search-dg'" style="padding:0 5px;" onclick="xTool.search(this)"><span class="l-btn-left l-btn-icon-left"><span class="l-btn-text">查询</span><span class="l-btn-icon icon-search">&nbsp;</span></span></a>
                            &nbsp;&nbsp;
                            <a href="javascript:void(0)" class="xui-linkbutton l-btn" data-options="iconCls:'icon-clear',datagrid:'#search-dg'" style="padding:0 5px;" onclick="xTool.reset(this)"><span class="l-btn-left l-btn-icon-left"><span class="l-btn-text">重置</span><span class="l-btn-icon icon-clear">&nbsp;</span></span></a>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </form>
    </div>
    <br>
    
    <div class="xui-datagrid datagrid" style="min-width: 800px;" id="search-dg" data-options="[myGridDefaults, {idField:'rec_id',transition:myDefaultTransition}]"><div class="datagrid-header">影印件列表</div><div class="datagrid-body"><div class="datagrid-toolbar"></div><div class="datagrid-view"><table class="datagrid-table" border="0" cellspacing="0" cellpadding="0"><thead><tr class="datagrid-header-row"><th class="datagrid-header-rownumber" data-options="field:'rn',rownumber:true"></th><th data-options="field:'apptype',width:120,formatter:formatApptype">业务类型</th><th data-options="field:'copy_type',width:120,formatter:formatCopyType">影印件类型</th><th data-options="field:'file_name',width:120,formatter:formatFileName">文件名</th><th data-options="field:'created_by',width:80">上传人</th><th data-options="field:'created_time',width:140">上传日期</th><th data-options="field:'proc_st',width:100,formatter:formatProcSt">记录处理状态</th><th data-options="field:'op',width:100,formatter:formatOp">操作</th></tr></thead><tbody></tbody></table></div><div class="datagrid-pager"></div></div></div>
    </div>
    <script>
    	
    var myDefaultTransition = xConfig['status_transition']['C'];
    	
    function formatApptype(value, rowData, rowIndex) {
    	return xTool.formatField(xConfig['apptype'], value);
    }
    
    function formatCopyType(value, rowData, rowIndex) {
    	return xTool.formatField(xConfig['copy_type'], value);
    }	
    	
    function formatFileName(value, rowData, rowIndex) {
    	var queryString = $.param({url:rowData.file_url}).replace(/\+/g, '%20');
    	return '<a href="preview-photo.html?'+queryString+'" target="_blank">'+value+'</a>';
    }
    
    function formatProcSt(value, rowData, rowIndex) {
    	return xTool.formatField(xConfig['proc_st']['C'], value);
    }
    
    function onClickCheck1(rowIndex) {
    	var rows = $('#search-dg').datagrid('getRows');
    	xTool.send('/action/ms/photo-copy/check1-pass', rows[rowIndex], function (data) {
            if(data.code == 0) {
            	$('#search-dg').datagrid('reload');
            }
        });
    }
    
    function onClickDelete(rowIndex) {
    	var rows = $('#search-dg').datagrid('getRows');
    	xTool.showConfirm('确认要删除？', function (r) {
    		if(r) {
    			xTool.send('/action/ms/photo-copy/delete', rows[rowIndex], function (data) {
		            if(data.code == 0) {
		            	$('#search-dg').datagrid('reload');
		            }
		        });
    		}
    	});
    }
    
    function formatOp(value, rowData, rowIndex) {
    	var s = '<a href="'+xTool.getUrl(rowData.file_url)+'?'+encodeURIComponent(rowData.file_name)+'" target="_blank">下载</a>';
    	if(rowData.proc_st == '1') {
	    	s += '<a href="javascript:void(0)" onClick="onClickDelete('+rowIndex+')" style="padding-left:5px;">删除</a>'
    	}
    	return s;
    }
    
    	
    function onClickUpload() {
    	if ($('#detail-fm').form('enableValidation').form('validate') != true) {
            return false;
        }
    	$('#file_upload').uploadify('upload', '*');
    }
	
	function onClickBatchUpload() {    	
    	$('#batch_file_upload').uploadify('upload', '*');
    }
    	
    function createPhotoCopy(name, url, data) {
    	console.log(data);
    	
    	data.mcht_id = g_query.mcht_id;
		$.extend(data, {
			file_name: name,
			file_url: url
		});
		
		xTool.send('/action/ms/photo-copy/create', data, function (data) {
            if(data.code == 0) {
            	$('#search-dg').datagrid('appendRow', data.data);
            }
        });
    }
    
    function batchCreatePhotoCopy(name, url) {
    	//var data = $('#detail-fm').serializeObject();
			var data = {};    	
    	data.mcht_id = g_query.mcht_id;
		$.extend(data, parseFileName(name),  {
			file_name: name,
			file_url: url
		});
		
		xTool.send('/action/ms/photo-copy/create', data, function (data) {
            if(data.code == 0) {
            	$('#search-dg').datagrid('appendRow', data.data);
            }
        });
    }
    
    function serializeSearchForm(data) {
		$.extend(data, g_search);
	}
	
	function parseCopyType(name) {
	  	var rows = [
	  		{'prefix':'商户营业执照','copy_type':'01'},
			{'prefix':'税务登记证明','copy_type':'02'},
			{'prefix':'企业法人身份证','copy_type':'03'},
			{'prefix':'考察照片','copy_type':'04'},
			{'prefix':'商户信息调查表','copy_type':'05'},
			{'prefix':'商户协议','copy_type':'06'},
			{'prefix':'组织代码证','copy_type':'07'},
			{'prefix':'新增终端审批表','copy_type':'08'},
			{'prefix':'商户信息变更表','copy_type':'09'},
			{'prefix':'押金减免单','copy_type':'10'},
			{'prefix':'风险承诺函','copy_type':'11'},
			{'prefix':'代理协议','copy_type':'12'},
			{'prefix':'账号授权书','copy_type':'13'},
			{'prefix':'商户特批单','copy_type':'14'},
			{'prefix':'门面租赁协议','copy_type':'15'},
			{'prefix':'账号复印件','copy_type':'16'},
			{'prefix':'其他','copy_type':'17'} 		
	  	];
	  	
	  	var i, row;
	  	for(i = 0; i < rows.length; i ++) {
	  		row = rows[i];
	  		if(name.indexOf(row.prefix) == 0) {
	  			return row.copy_type
	  		}
	  	}
	  	
	  	
	  	return null;
	  }
	  
	  function parseAppType(name) {
	  	if(xTool.inObjectArray(name, xConfig['apptype'])) {
				return name;
			}
			
	  	return null;
	  }
	
		
	
		function parseFileName(name) {
			var data = {};
			var a = name.split('-');
			if(a.length == 3) {
				data.mchnt_cd = a[0];
				data.apptype = parseAppType(a[1]);
				data.copy_type = parseCopyType(a[2]);
				
				if(data.apptype && data.copy_type) {
					return data;
				}
			} else if(a.length == 2) {
				data.apptype = parseAppType(a[0]);
				data.copy_type = parseCopyType(a[1]);
				
				if(data.apptype && data.copy_type) {
					return data;
				}
			} else if(a.length == 1) {
				data.copy_type = parseCopyType(a[0]);
								
				if(data.copy_type) {
					return data;
				}
			}
			
			return null;
		}
	
	function initUpload() {
		
		$('#file_upload').uploadify({
        	'auto' : false,
        	'buttonText' : '浏览...',
        	'fileSizeLimit' : '1MB',
        	'fileTypeDesc' : '图片文件',
        	'fileTypeExts' : '*.gif; *.jpg; *.png',
        	//'buttonImage' : '../../images/browse-btn.png',
            'swf' : '../../js/uploadify.swf',
            'uploader' : '/action/ms/upload?suid=' + Cookies.get('suid') + ';si=' + Cookies.get('si') + ';1',
            'itemTemplate' : '<div id="${fileID}" class="uploadify-queue-item">'+
                    '<div class="cancel">'+
                        '<a href="javascript:$(\'#${instanceID}\').uploadify(\'cancel\', \'${fileID}\')">X</a>'+
                    '</div>'+
                    '<span class="fileName">${fileName} (${fileSize})</span><span class="data">sfd</span>'+
                '</div>',
            'onUploadSuccess' : function(file, data, response) {
            	data = $.evalJSON(data);
            	if(data.code == 0) {
            		createPhotoCopy(file.name, data.url, $('#file_upload').data(file.id));
            	} else {
            		xTool.showError(data.msg);
            	}
        	}, 'onDialogOpen' : function() {
	        	var data = $('#detail-fm').serializeObject();
	        	var s = '&nbsp;&nbsp;';
	        	s += xTool.formatField(xConfig['apptype'], data.apptype);
	        	s += '&nbsp;&nbsp;';
	        	s += xTool.formatField(xConfig['copy_type'], data.copy_type);
	        	
	            $('#file_upload').uploadify('settings', 'itemTemplate', '<div id="${fileID}" class="uploadify-queue-item">'+
                    '<div class="cancel">'+
                        '<a href="javascript:$(\'#${instanceID}\').uploadify(\'cancel\', \'${fileID}\')">X</a>'+
                    '</div>'+
                    '<span class="fileName">${fileName} (${fileSize})</span><span class="data">'+s+'</span>'+
                '</div>');
	        }, 'onSelect' : function(file) {
	        	var data = $('#detail-fm').serializeObject();
	        	$('#file_upload').data(file.id, data);
		        if ($('#detail-fm').form('enableValidation').form('validate') != true) {
		            $('#file_upload').uploadify('cancel', file.id);
		        }
	        },'onQueueComplete' : function(queueData) {
	            xTool.showInfo('成功上传'+ queueData.uploadsSuccessful + '个文件');
	        }
        });
        
        $('#batch_file_upload').uploadify({
        	'auto' : false,
        	'buttonText' : '浏览...',
        	'fileSizeLimit' : '1MB',
        	'fileTypeDesc' : '图片文件',
        	'fileTypeExts' : '*.gif; *.jpg; *.png',
        	//'buttonImage' : '../../images/browse-btn.png',
            'swf' : '../../js/uploadify.swf',
            'uploader' : '/action/ms/upload?suid=' + Cookies.get('suid') + ';si=' + Cookies.get('si') + ';1',
            'onUploadSuccess' : function(file, data, response) {
            	data = $.evalJSON(data);
            	if(data.code == 0) {
            		batchCreatePhotoCopy(file.name, data.url);
            	} else {
            		xTool.showError(data.msg);
            	}
        	},'onSelect' : function(file) {
		        //命名规则检查
		        if(parseFileName(file.name)) {
		        } else {
		        	$('#batch_file_upload').uploadify('cancel', file.id);
		        	xTool.showInfo(file.name+'不符合命名规则');
		        }
	        },'onQueueComplete' : function(queueData) {
	            xTool.showInfo('成功上传'+ queueData.uploadsSuccessful + '个文件');
	        }
        });
	}
    	
	var g_query;
	var g_search = {};
    $(function() {
        //当前模式
		g_query  = xTool.parseQueryString();
		
		if(g_query.displayType == 'update') {
			initUpload();
		} else {
			$('#upload-div').hide();
		}
			
		g_search.mcht_id = g_query.mcht_id;  
		
		if(g_query.apptype) {
			$('#detail-fm').form('load',{
				apptype: g_query.apptype
			});
			
			$('#batch-detail-fm').form('load',{
				apptype: g_query.apptype
			});
			
			$('#search-fm').form('load',{
				apptype: g_query.apptype
			});
		}
		
		//查询
		setTimeout(function() {
			$('#search-btn').click();
		}, 0);
    });
    </script>


</body></html>