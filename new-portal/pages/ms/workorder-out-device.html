<!doctype html>
<html><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="renderer" content="webkit">
    <title>工作单出库</title>
    <link rel="stylesheet" type="text/css" href="../../js/themes/default/xui.css">
    <link rel="stylesheet" type="text/css" href="../../js/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="../../css/tool.css">
    <script type="text/javascript" src="../../js/jquery.min.js"></script>
    <script type="text/javascript" src="../../js/jquery.xui.min.js"></script>
    <script type="text/javascript" src="../../js/My97DatePicker/WdatePicker.js"></script><link href="../../js/My97DatePicker/skin/WdatePicker.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="../../js/jquery.xconfig.js"></script>
    <script type="text/javascript" src="../../js/jquery.tool.js"></script>
</head>

<body class="search-body">
	<div class="search-div">
        <div>
            <form id="search-fm" class="form search-form" action="/action/ms/workorder/search" method="post" data-options="onSerialize:onSerializeSearchForm">
                <table class="table" style="width:950px;">
            	<caption>
                查询工作单
                </caption>
                  <tbody><tr>
                    <td class="right td20"><label>工作单号：</label></td>
                    <td class="td30"><input type="text" name="work_order_no"></td>
                    <td class="right td20"><label>工作单类型：</label></td>
                    <td class="td30"><span class="xui-combobox combobox" data-options="required:true,data:xConfig['work_order_type']"><input type="text" class="combobox-text"><input type="hidden" name="work_order_type" class="combobox-value"><span class="combobox-addon"><i class="combobox-icon combobox-arrow"></i></span></span></td>
                  </tr>
                  <tr>
                    <td class="right td20"><label>商户号：</label></td>
                    <td class="td30"><input type="text" name="mchnt_cd"></td>
                    <td class="right td20"><label>终端号：</label></td>
                    <td class="td30"><input type="text" name="term_id"></td>
                  </tr>
                  <tr>
                    <td class="right td20"><label>工商营业执照名称：</label></td>
                    <td class="td30"><input type="text" name="mcht_name"></td>
                    <td class="right td20"><label>派单日期：</label></td>
                    <td class="td30"><input id="created_time" type="text" class="Wdate" name="created_time" style="width:100px;" onfocus="WdatePicker({onpicked:function(){$dp.$('created_time2').focus();},maxDate:'#F{$dp.$D(\'created_time2\')}'})">
                      <input id="created_time2" type="text" class="Wdate" name="created_time2" style="width:100px;" onfocus="WdatePicker({minDate:'#F{$dp.$D(\'created_time\')}'})"></td>
                  </tr>
                  <tr>
                    <td class="right td20"><label>执行人：</label></td>
                    <td class="td30"><input type="text" name="work_id"></td>
                    <td class="right td20"><label>计划执行日期：</label></td>
                    <td class="td30"><input type="text" class="Wdate" onfocus="WdatePicker()" name="plan_date" style="width:100px;"></td>
                  </tr>
				  <tr>
	                <td class="right td20"><label>终端标识码：</label></td>
	                <td class="td30"><input type="text" name="term_no"></td>
	                <td class="right td20"></td>
	                <td class="td30"></td>
	              </tr> 
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="center">
                                <div style="margin:5px;"></div>
                                <a href="javascript:void(0)" id="search-btn" class="xui-linkbutton l-btn" data-options="iconCls:'icon-search',datagrid:'#search-dg',onSuccess:onSearchSuccess" style="padding:0 5px;" onclick="xTool.search(this)"><span class="l-btn-left l-btn-icon-left"><span class="l-btn-text">查询</span><span class="l-btn-icon icon-search">&nbsp;</span></span></a>
                                <a href="javascript:void(0)" class="xui-linkbutton l-btn" data-options="iconCls:'icon-clear',datagrid:'#search-dg'" style="padding:0 5px;" onclick="xTool.reset(this)"><span class="l-btn-left l-btn-icon-left"><span class="l-btn-text">重置</span><span class="l-btn-icon icon-clear">&nbsp;</span></span></a>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </form>
        </div>
        <br>
        <div class="xui-datagrid datagrid" style="min-width: 800px;" id="search-dg" data-options="pagination:true"><div class="datagrid-header">工作单列表</div><div class="datagrid-body"><div class="datagrid-view"><table class="datagrid-table" border="0" cellspacing="0" cellpadding="0"><thead><tr class="datagrid-header-row"><th class="datagrid-header-rownumber" data-options="field:'rn',rownumber:true"></th><th data-options="field:'op',width:50,formatter:formatOp">操作</th><th data-options="field:'work_order_no',width:100">工作单号</th><th data-options="field:'work_order_type',width:120,formatter:formatWorkOrderType">工作单类型</th><th data-options="field:'term_no',width:80">终端标识码</th><th data-options="field:'mcht_name',width:120">工商营业执照名称</th><th data-options="field:'work_id',width:120,formatter:formatWorkId">执行人</th><th data-options="field:'plan_date',width:100,formatter:formatPlanDate">计划执行日期</th><th data-options="field:'sender_id',width:80">派单人</th><th data-options="field:'sender_date',width:140">派单时间</th></tr></thead><tbody></tbody></table></div><div class="datagrid-pager"></div></div></div>
    </div>
    
    <div class="detail-div" style="display: none;">
    	<form id="workorder-fm" class="form view" action="/action/ms/device-info/view" method="post" style="width:950px;">
            <div style="padding:5px;">
                <table class="table" style="width:100%;">
                <caption>
                工作单信息
                </caption>
                    <tbody><tr>
                      <td class="right td20"><label>工作单号：</label></td>
                      <td class="td30"><input name="work_order_no" type="text"></td>
                      <td class="right td20"><label>终端标识码：</label></td>
                      <td class="td30"><input name="term_no" type="text" class="xui-validatebox" data-options=""></td>
                    </tr>
                    <tr>
                      <td class="right td20"><label>门店名称：</label></td>
                      <td class="td30"><input name="marchant_name" type="text" class="xui-validatebox" data-options=""></td>
                      <td class="right td20"><label>机具类型：</label></td>
                      <td class="td30"><span class="td30 clear-readonly">
                        <span class="xui-combobox combobox" id="equi_type" data-options="panelHeight:'auto',editable:false,required:true,data:xConfig['equi_type']"><input type="text" class="combobox-text"><input type="hidden" name="equi_type" class="combobox-value"><span class="combobox-addon"><i class="combobox-icon combobox-arrow"></i></span></span>
                      </span></td>
                    </tr>
                    <tr>
                      <td class="right td20"><label>POS纸数量：</label></td>
                      <td class="td30"><input name="paper_num" type="text" class="xui-validatebox" id="paper_num" data-options=""></td>
                      <td class="right td20"><label>标牌数量：</label></td>
                      <td class="td30"><input name="u_signs" type="text" class="xui-validatebox" data-options=""></td>
                    </tr>
                    <tr>
                      <td class="right td20"><label>终端投资方：</label></td>
                      <td class="td30"><span class="td30 clear-readonly">
                        <span class="xui-combobox combobox" id="teminal_product" data-options="panelHeight:'auto',editable:false,required:true"><input type="text" class="combobox-text"><input type="hidden" name="teminal_product" class="combobox-value"><span class="combobox-addon"><i class="combobox-icon combobox-arrow"></i></span></span>
                      </span></td>
                      <td class="right td20">&nbsp;</td>
                      <td class="td30">&nbsp;</td>
                    </tr>
                </tbody></table>
            </div>
        </form>
        <form id="add-fm" class="form view" action="/action/ms/device-info/view" method="post" style="width:950px;">
            <div style="padding:5px;">
                <table class="table" style="width:100%;">
                <caption>
                设备
                </caption>
                    <tbody><tr>
                        <td class="right td20">
                            <label>设备编号：</label>
                        </td>
                        <td class="td30">
                        	<input type="text" style="display:none;">
                            <input type="text" id="device_no" name="device_no" class="xui-validatebox" style="text-transform:uppercase;" data-options="required:true">
                            <label class="required">*</label>
                        </td>
                        <td class="td20">
                            <a href="javascript:void(0)" id="add-btn" class="button xui-linkbutton l-btn" data-options="url:'/action/ms/device-info/workorder-out',datagrid:'#add-dg'" style="padding:0 5px;" onclick="onClickAdd(this)"><span class="l-btn-left"><span class="l-btn-text">增加</span></span></a>
                            <a href="javascript:void(0)" class="xui-linkbutton l-btn" style="padding:0 5px;" onclick="xTool.reset(this)"><span class="l-btn-left"><span class="l-btn-text">重置</span></span></a>
                        </td>
                        <td class="td30">&nbsp;</td>
                    </tr>
                </tbody></table>
            </div>
        </form>
        <form id="detail-fm" class="form view" action="/action/ms/device-info/view" method="post" style="width:950px;">
            <div style="padding:5px;">
                <table class="table" style="width:100%;">
                <caption>出库信息</caption>
                    <tbody><tr>
                      <td class="right td20"><label>工作单号：</label></td>
                      <td class="td30"><input name="work_order_no" type="text" class="xui-validatebox" id="work_order_no" readonly="" data-options="required:true">
                        <label class="required">*</label></td>
                        <td class="right td20">
                            <label>经手人：</label>
                        </td>
                        <td class="td30">
                            <input type="text" id="hand_id" name="hand_id" class="xui-validatebox" data-options="required:true">
                            <label class="required">*</label>
                        </td>
                    </tr>
                    <tr>
                      <td class="right td20"><label>备注：</label></td>
                      <td class="td30"><input type="text" name="note" class="xui-validatebox" data-options="" id="note"></td>
                      <td class="right td20">&nbsp;</td>
                      <td class="td30">&nbsp;</td>
                    </tr>
                </tbody></table>
            </div>

            <div style="text-align:center;">
                <div style="margin:5px;"></div>
                <a href="javascript:void(0)" id="add-submit-btn" class="button add xui-linkbutton l-btn" data-options="disabled:true,iconCls:'icon-ok',url:'/action/ms/device-info/workorder-out',datagrid:'#add-dg'" style="padding:0 5px;" onclick="onClickAddSubmit(this)"><span class="l-btn-left l-btn-icon-left"><span class="l-btn-text">提交</span><span class="l-btn-icon icon-ok">&nbsp;</span></span></a>
            	<a href="javascript:void(0)" id="return-btn" class="xui-linkbutton l-btn" data-options="iconCls:'icon-return'" style="padding:0 5px;" onclick="xTool.returnSearch(this)"><span class="l-btn-left l-btn-icon-left"><span class="l-btn-text">返回</span><span class="l-btn-icon icon-return">&nbsp;</span></span></a></div>
        </form>
        <div style="margin:5px;"></div>
        
	    <div class="xui-datagrid datagrid" style="min-width: 800px;" id="add-dg" data-options="rownumbers:true,toolbar:'#add-dg-tb'"><div class="datagrid-body"><div class="datagrid-toolbar"><a href="javascript:void(0)" class="action xui-linkbutton l-btn l-btn-plain" onclick="deleteAddDg(this)" data-options="plain:true,iconCls:'icon-remove',datagrid:'#add-dg'"><span class="l-btn-left l-btn-icon-left"><span class="l-btn-text">删除</span><span class="l-btn-icon icon-remove">&nbsp;</span></span></a></div><div class="datagrid-view"><table class="datagrid-table" border="0" cellspacing="0" cellpadding="0"><thead><tr class="datagrid-header-row"><th class="datagrid-header-rownumber" data-options="field:'rn',rownumber:true"></th><th class="datagrid-td-check" data-options="field:'chk',checkbox:true"><div class="datagrid-header-check"><input type="checkbox"></div></th><th data-options="field:'device_no',width:120">设备编号</th><th data-options="field:'depot_id',width:120,formatter:formatDepotId">仓库</th><th data-options="field:'manufacturer',width:120">生产厂家</th><th data-options="field:'device_type',width:120">设备型号</th><th data-options="field:'term_inves',width:120,formatter:formatTermInves">终端投资方</th></tr></thead><tbody></tbody></table></div></div></div>
    </div>
    <script>
        var myDefaultTransition = [];
        
        function onSerializeSearchForm(data) {
        	data.debug_flag = '1';
        	data.proc_st = '1';
        	data.equip_type = '1';
        }
        
        function formatPlanDate(value) {
            return value.substr(0, 10);
        }

        function formatWorkOrderType(value, rowData, rowIndex) {
            return xTool.formatField(xConfig['work_order_type'], value);
        }

        function formatProcSt(value, rowData, rowIndex) {
            return xTool.formatField(xConfig['proc_st']['D'], value);
        }
        
        function formatWorkId(value, rowData, rowIndex) {
            return xTool.formatField(xConfig['work_id'], value) || value;
        }
        
        function formatTermInves(value, rowData, rowIndex) {
            return xTool.formatField(xConfig['term_inves'], value);
        }
        
        function formatDepotId(value, rowData, rowIndex) {
            return xTool.formatField(xConfig['depot_id'], value, 'depot_id', 'depot_name');
        }

        function onClickAdd(target) {
            var opts = $.parser.parseOptions(target);
            var f = $(target).closest('form');
            var data = f.serializeObject();
			data.device_no=data.device_no.toUpperCase();
            if (f.form('enableValidation').form('validate') != true) {
                return false;
            }
            f.form('disableValidation');

            $(target).linkbutton('disable');
            xTool.send('/action/ms/device-info/view', data, function (data) {
                $(target).linkbutton('enable');
                $('#add-submit-btn').linkbutton('enable');

                if (data.code == 0) {
                    if (data.data.device_no) {
                        var rows = $(opts.datagrid).datagrid('getRows');

                        if (xTool.inObjectArray(data.data.device_no, rows, 'device_no')) {
                            xTool.showError('设备不能重复添加');
                        } else {
                            $(opts.datagrid).datagrid('appendRow', data.data);
                        }
                    } else {
                        xTool.showError('设备不存在');
                    }
                }
            });
        }

        function onClickAddSubmit(target) {
            var opts = $.parser.parseOptions(target);
            var f = $(target).closest('form');
            var data = f.serializeObject();

            if (f.form('enableValidation').form('validate') != true) {
                return false;
            }
            f.form('disableValidation');

            //console.log(data);

            var rows = $('#add-dg').datagrid('getRows');
            data.rows = rows;

            $(target).linkbutton('disable');
            xTool.send(opts.url, data, function (data) {
            	
                if (data.code == 0) {
                	var info = '操作成功';
                	if(data.data.info) {
                		info += ','+data.data.info;
                	}
                    xTool.showInfo(info);
                    $(opts.datagrid).datagrid('loadData',[]);
                    $('#return-btn').click();
                } else {
                	$(target).linkbutton('enable');
                }
            });
        }


		function onClickOutDeivce(rowIndex) {
	    	var rows = $('#search-dg').datagrid('getRows');
	    	var param = {
	    		rec_id: rows[rowIndex].rec_id
	    	};
			
	        xTool.send('/action/ms/workorder/view', param, function (data) {
                if (data.code == 0) {
                    $('#workorder-fm').form('load', data.data);
                    $('#work_order_no').val(data.data.work_order_no);
                    
                    $('#hand_id').val(formatWorkId(data.data.work_id));
                    
                    $('#add-dg').datagrid('loadData', data.device);
                    
                    if(data.device.length > 0) {
                    	$('#add-submit-btn').linkbutton('enable');
                    }
                }
            });
            
            $('.search-div').hide();
        	$('.detail-div').show();
        	$('#add-dg').datagrid('loadData',[]);
        	xTool.transformStatus($('#workorder-fm')[0], 'view');
	    }
		
		function formatOp(value, rowData, rowIndex) {
	    	var s = '<a href="#" onclick="onClickOutDeivce('+rowIndex+')">出库</a>';
	    	
	    	return s;
	    }
	    
	    function deleteAddDg(target) {
       		 var opts = $.parser.parseOptions(target);
       		 var dg = $(opts.datagrid);
			 var rows = dg.datagrid('getChecked');
			 var i, index;
			 for(i = 0; i < rows.length; i ++) {
			 	index = dg.datagrid('getRowIndex', rows[i]);
			 	dg.datagrid('deleteRow', index);
			 }
        }
        
        function onSearchSuccess(data) {
			if(data.total == 0 && g_no_data_found) {				 
				xTool.showInfo('没有查到数据');
			}
			g_no_data_found = true;
		}
	    
	    function initCombobox() {
            xTool.send('/action/ms/parameter/list', {
                term_inves: '1',
                depot_id: '1',
                work_id: '1'
            }, function (data) {
                if (data.code == 0) {
                    $('#teminal_product').combobox('loadData', data.term_inves);
                                        
                    //更新数据
                    xConfig['term_inves'] = data.term_inves;
                    xConfig['depot_id'] = data.depot_id;
                    xConfig['work_id'] = data.work_id;
                }
            });
        }
        
        var g_no_data_found = true;
        $(function () {
        	initCombobox();
        	
        	//事件
			$('#device_no').keyup(function(event) {
				if(event.which == 13) {
					$('#add-btn').click();
					$(this).focus().val('');
				}
			});
			
			setTimeout(function() {
        		g_no_data_found = false;
        		$('#search-btn').trigger('click');
			
				setInterval(function() {
					g_no_data_found = false;
					$('#search-btn').trigger('click');
				}, 180000);
			}, 0);
        });

    </script>


</body></html>