<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="renderer" content="webkit">
    <title>自主业务收入</title>
    <link rel="stylesheet" type="text/css" href="../../js/themes/default/xui.css">
    <link rel="stylesheet" type="text/css" href="../../js/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="../../css/tool.css">
    <script type="text/javascript" src="../../js/jquery.min.js"></script>
    <script type="text/javascript" src="../../js/jquery.xui.min.js"></script>
    <script type="text/javascript" src="../../js/My97DatePicker/WdatePicker.js"></script>
    <link href="../../js/My97DatePicker/skin/WdatePicker.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="../../js/jquery.xconfig.js"></script>
    <script type="text/javascript" src="../../js/jquery.xdistrict.js"></script>
    <script type="text/javascript" src="../../js/jquery.tool.js"></script>
</head>

<body>
    <div>
        <div>
            <form id="search-fm" class="form search-form" action="/action/ms/bb-zzywsr-his/search" method="post">
                <table class="table" style="width:950px;">
                    <caption>查询自主业务收入</caption>
                    <tbody>
                        <tr>
                            <td class="right td20">
                                <label>月份：</label>
                            </td>
                            <td class="td30">
                                <input id="settle_mon" type="text" class="Wdate xui-validatebox" name="settle_mon" style="width:100px;" onfocus="WdatePicker({dateFmt:'yyyy-MM'})" data-options="required:true">
                                <label class="required">*</label>
                            </td>
                            <td class="right td20"><label>收入所属部门：</label></td>
                        <td class="td30 clear-readonly"><span class="xui-combobox combobox" id="srssbm" data-options="editable:false"><input type="text" class="combobox-text"><input type="hidden" name="srssbm" class="combobox-value"><span class="combobox-addon"><i class="combobox-icon combobox-arrow"></i></span></span></td>
                        </tr>
                        <tr>
                            <td class="right td20"><label>客户地区(业务部)：</label></td>
                        <td class="td30 clear-readonly"><span class="xui-combobox combobox" id="khdq" data-options="editable:false"><input type="text" class="combobox-text"><input type="hidden" name="khdq" class="combobox-value"><span class="combobox-addon"><i class="combobox-icon combobox-arrow"></i></span></span></td>
                            <td class="right td20"><label>拓展人：</label></td>
                            <td class="td30">
                                <input type="text" name="tzr">
                            </td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="center">
                                <div style="margin:5px;"></div>
                                <a href="javascript:void(0)" class="xui-linkbutton l-btn" data-options="iconCls:'icon-search',datagrid:'#search-dg',onBefore:onBeforeSearch" style="padding:0 5px;" onclick="xTool.search(this)"><span class="l-btn-left l-btn-icon-left"><span class="l-btn-text">查询</span><span class="l-btn-icon icon-search">&nbsp;</span></span></a> &nbsp;&nbsp;
                                <a href="javascript:void(0)" class="xui-linkbutton l-btn" data-options="iconCls:'icon-clear',datagrid:'#search-dg'" style="padding:0 5px;" onclick="xTool.reset(this)"><span class="l-btn-left l-btn-icon-left"><span class="l-btn-text">重置</span><span class="l-btn-icon icon-clear">&nbsp;</span></span></a> &nbsp;&nbsp;
                                <a href="javascript:void(0)" class="xui-linkbutton l-btn" data-options="iconCls:'icon-export',url:'/action/ms/bb-zzywsr-his/export',onBefore:onBeforeSearch" style="padding:0 5px;" onclick="xTool.exportData(this)"><span class="l-btn-left l-btn-icon-left"><span class="l-btn-text">导出</span><span class="l-btn-icon icon-export">&nbsp;</span></span></a>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </form>
        </div>
        <br>
        <div class="xui-datagrid datagrid" style="min-width: 800px;" id="search-dg" data-options="pagination:true">
            <div class="datagrid-header">自主业务收入</div>
            <div class="datagrid-body">
                <div class="datagrid-view">
                    <table class="datagrid-table" border="0" cellspacing="0" cellpadding="0">
                        <thead>
                            <tr class="datagrid-header-row">
                                <th class="datagrid-header-rownumber" data-options="field:'rn',rownumber:true"></th>
                                <th data-options="field:'srssbm'">收入所属部门</th>
                                <th data-options="field:'khdq'">客户地区</th>
                                <th data-options="field:'shmc'">商户名称</th>
                                <th data-options="field:'shbh'">商户编号</th>
                                <th data-options="field:'zdbh'">终端编号</th>
                                <th data-options="field:'jjcq'">机具产权</th>
                                <th data-options="field:'zdbsm'">终端标识码</th>
                                <th data-options="field:'whr'">维护人</th>
                                <th data-options="field:'tzr'">拓展人</th>
                                <th data-options="field:'gdsj'">归档时间</th>
                                <th data-options="field:'zdzt'">终端状态</th>
                                <th data-options="field:'ywlx'">业务类型</th>
                                <th data-options="field:'jyje'">交易金额</th>
                                <th data-options="field:'jybs'">交易笔数</th>
                                <th data-options="field:'shsxf'">商户手续费</th>
                                <th data-options="field:'tlsxf'">税前收入</th>
                                <th data-options="field:'khsrbhs'">考核收入（不含税）</th>
                                <th data-options="field:'ppf'">品牌费</th>
                                <th data-options="field:'zjcb'">直接成本</th>
                                <th data-options="field:'qdfr'">渠道分润</th>
                                <th data-options="field:'shsy'">税后收益</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="datagrid-pager"></div>
            </div>
        </div>
    </div>
    <script>
    var provinceData = xProvinceCityDistrict['province'];

    function parseDate(s, format) {
        var date = new Date(1970, 0, 1, 0, 0, 0, 0);
        var o = {
            "y+": 'setFullYear', //year
            "M+": 'setMonth', //month
            "d+": 'setDate', //day
            "h+": 'setHours', //hour
            "m+": 'setMinutes', //minute
            "s+": 'setSeconds', //second
            "S": 'setMilliseconds' //millisecond
        }

        for (var k in o) {
            var result;
            if ((result = new RegExp("(" + k + ")").exec(format)) != null) {
                console.log(s.substr(result.index, result[0].length));
                if(k == 'M+') {
                    date[o[k]](s.substr(result.index, result[0].length)-1);
                } else {
                    date[o[k]](s.substr(result.index, result[0].length));    
                }                
            }
        }

        return date;
    };

    function formatDate(date, format) {
        var o = {
            "M+": date.getMonth() + 1, //month
            "d+": date.getDate(), //day
            "h+": date.getHours(), //hour
            "m+": date.getMinutes(), //minute
            "s+": date.getSeconds(), //second
            "q+": Math.floor((date.getMonth() + 3) / 3), //quarter
            "S": date.getMilliseconds() //millisecond
        }
        if (/(y+)/.test(format))
            format = format.replace(RegExp.$1, (date.getFullYear() + "").substr(4 - RegExp.$1.length));
        for (var k in o)
            if (new RegExp("(" + k + ")").test(format))
                format = format.replace(RegExp.$1, RegExp.$1.length == 1 ? o[k] : ("00" + o[k]).substr(("" + o[k]).length));
        return format;
    };

    function maxDate() {
        var date = parseDate($('#settle_date').val(), 'yyyy-MM-dd'); //#F{$dp.$D(\'settle_date\',{M:1});}';
        var lastDay = new Date(date.getFullYear(), date.getMonth()+1, 0); 
        var now = new Date();
        var endDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()-3);
        console.log(formatDate(date, 'yyyy-MM-dd'));
        console.log(formatDate(lastDay, 'yyyy-MM-dd'));

        if(lastDay < endDay) {
            endDay = lastDay;
        }
        return formatDate(endDay, 'yyyy-MM-dd');
    }

    function onChangeProvince(newValue, oldValue) {
        if (newValue) {
            $('#city').combobox('clear').combobox('loadData', xProvinceCityDistrict['city'][newValue]);
            $('#district').combobox('clear').combobox('loadData', []);
        }
    }

    function onChangeCity(newValue, oldValue) {
        if (newValue) {
            var province = $('#province').combobox('getValue');
            $('#district').combobox('clear').combobox('loadData', xProvinceCityDistrict['district'][province + newValue]);
        }
    }

    function onBeforeSearch() {
        return $('#search-fm').form('enableValidation').form('validate');
    }

    function initCombobox() {
        xTool.send('/action/ms/parameter/list', {
            department: '1',
            srssbm: '1'
        }, function(data) {
            if (data.code == 0) {
                $('#srssbm').combobox('loadData', data.srssbm);
                $('#khdq').combobox('loadData', data.department);
            }
        });
    }

    $(function() {
        initCombobox();
    })
    </script>
</body>

</html>
