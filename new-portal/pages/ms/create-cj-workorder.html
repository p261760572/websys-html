<!doctype html>
<html><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="renderer" content="webkit">
    <title>撤机工作单</title>
    <link rel="stylesheet" type="text/css" href="../../js/themes/default/xui.css">
    <link rel="stylesheet" type="text/css" href="../../js/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="../../css/tool.css">
    <script type="text/javascript" src="../../js/jquery.min.js"></script>
    <script type="text/javascript" src="../../js/jquery.xui.min.js"></script>
    <script type="text/javascript" src="../../js/My97DatePicker/WdatePicker.js"></script><link href="../../js/My97DatePicker/skin/WdatePicker.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="../../js/jquery.xconfig.js"></script>
    <script type="text/javascript" src="../../js/jquery.tool.js"></script>
</head>

<body class="search-body" style="padding:5px;">
	<div class="search-div">
    <div>
        <form id="search-fm" class="form search-form" action="/action/ms/term-info/search" method="post" data-options="onSerialize:serializeSearchForm">
            <table class="table" style="width:950px;">
        	<caption>
            查询终端信息
            </caption>
              <tbody><tr>
                <td class="right td20"><label>工商营业执照名称：</label></td>
                <td class="td30"><input type="text" name="mcht_name"></td>
                <td class="right td20"><label>工商营业执照证件号码：</label></td>
                <td class="td30"><input type="text" name="license_no"></td>
              </tr>
              <tr>
                <td class="right td20"><label>实际营业地址：</label></td>
                <td class="td30"><input type="text" name="addr"></td>
                <td class="right td20"><label>法人名称：</label></td>
                <td class="td30"><input type="text" name="cert_name"></td>
              </tr>
              <tr>
                <td class="right td20"><label>商户号：</label></td>
                <td class="td30"><input type="text" name="mchnt_cd"></td>
                <td class="right td20"><label>终端号：</label></td>
                <td class="td30"><input type="text" name="term_id"></td>
              </tr>
              <tr>
              	<td class="right td20"><label>终端标识码：</label></td>
                <td class="td30"><input type="text" name="term_no"></td>
                <td class="right td20"></td>
                <td class="td30"></td>
              </tr>
                </tbody><tfoot>
                    <tr>
                        <td colspan="4" class="center">
                            <div style="margin:5px;"></div>
                            <a href="javascript:void(0)" class="xui-linkbutton l-btn" data-options="iconCls:'icon-search',datagrid:'#search-dg'" style="padding:0 5px;" onclick="xTool.search(this)"><span class="l-btn-left l-btn-icon-left"><span class="l-btn-text">查询</span><span class="l-btn-icon icon-search">&nbsp;</span></span></a>
                            &nbsp;&nbsp;
                            <a href="javascript:void(0)" class="xui-linkbutton l-btn" data-options="iconCls:'icon-clear',datagrid:'#search-dg'" style="padding:0 5px;" onclick="xTool.reset(this)"><span class="l-btn-left l-btn-icon-left"><span class="l-btn-text">重置</span><span class="l-btn-icon icon-clear">&nbsp;</span></span></a>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </form>
    </div>
    <br>
    
    <div class="xui-datagrid datagrid" style="min-width: 800px;" id="search-dg" data-options="[myGridDefaults, {idField:'rec_id',transition:myDefaultTransition}]"><div class="datagrid-header">终端信息</div><div class="datagrid-body"><div class="datagrid-toolbar"><a href="javascript:void(0)" class="action xui-linkbutton l-btn l-btn-plain" onclick="xTool.edit(this)" data-options="plain:true,iconCls:'icon-add',form:'#detail-fm',datagrid:'#search-dg',url:'/action/ms/cj-workorder/create',onSuccess:onSuccessCreate"><span class="l-btn-left l-btn-icon-left"><span class="l-btn-text">申请撤机</span><span class="l-btn-icon icon-add">&nbsp;</span></span></a></div><div class="datagrid-view"><table class="datagrid-table" border="0" cellspacing="0" cellpadding="0"><thead><tr class="datagrid-header-row"><th class="datagrid-header-rownumber" data-options="field:'rn',rownumber:true"></th><th data-options="field:'term_no',width:80">终端标识码</th><th data-options="field:'man',width:120">客户装机联系人</th><th data-options="field:'tel_no',width:120">客户装机联系电话</th><th data-options="field:'marchant_name',width:120">门店名称</th><th data-options="field:'installed_addr',width:120">客户装机地址</th><th data-options="field:'installed_date',width:100,formatter:formatDate">装机日期</th><th data-options="field:'maintained_by',width:120,formatter:formatWorkId">维护人</th><th data-options="field:'installed_status',width:80,formatter:formatInstalledStatus">安装状态</th></tr></thead><tbody></tbody></table></div><div class="datagrid-pager"></div></div></div>
    </div>
    <div class="detail-div" style="display: none;">
    	
    	<div style="padding:5px;">
    	</div>
    	<div class="xui-datagrid datagrid" style="min-width: 800px;" id="busi-binding-dg" data-options="pagination:false"><div class="datagrid-body"><div class="datagrid-view"><table class="datagrid-table" border="0" cellspacing="0" cellpadding="0"><thead><tr class="datagrid-header-row"><th class="datagrid-header-rownumber" data-options="field:'rn',rownumber:true"></th><th data-options="field:'apptype',width:100,formatter:formatApptype">业务类型</th><th data-options="field:'lc_fee_pre',width:140,formatter:formatLcFeePre">扣率</th><th data-options="field:'e_name',width:100">拓展人</th><th data-options="field:'app_st',width:100,formatter:formatAppSt">业务状态</th><th data-options="field:'psam_no',width:140">PSAM卡号</th><th data-options="field:'mchnt_cd',width:140">商户号</th><th data-options="field:'term_id',width:80">终端号</th></tr></thead><tbody></tbody></table></div></div></div>
    	
        <form id="detail-fm" class="form view" action="/action/ms/term-info/view" method="post" style="width:950px;" data-options="onLoad:onLoadDetailForm">
                <div style="padding:5px;">
                    <table class="table" style="width:100%;">
                    	<tbody><tr>
          <td class="right td20"><label>撤机单号：</label></td>
          <td class="td30"><input type="hidden" name="term_no"><input type="text" name="work_order_no" class="edit xui-validatebox" data-options="">
            <label class="required">*</label><label>(系统生成)</label></td>
          <td class="right td20"><label>联系人：</label></td>
          <td class="td30"><input type="text" name="linkman" class="xui-validatebox" data-options="required:true">
           <label class="required">*</label></td>
        </tr>

        <tr>
          <td class="right td20"><label>联系电话：</label></td>
          <td class="td30"><input type="text" name="telno" class="xui-validatebox" data-options="required:true">
           <label class="required">*</label></td>
          <td class="right td20"><label>撤机退款方式：</label></td>
          <td class="td30  clear-readonly"><span class="xui-combobox combobox" data-options="panelHeight:'auto',editable:false,required:true,data:xConfig['cj_refund_type']"><input type="text" class="combobox-text"><input type="hidden" name="cj_refund_type" class="combobox-value"><span class="combobox-addon"><i class="combobox-icon combobox-arrow"></i></span></span>
           <label class="required">*</label></td>
        </tr>

        <tr>
          <td class="right td20"><label>押金退付银行账号：</label></td>
          <td class="td30"><input type="text" name="pan" class="xui-validatebox" data-options="required:true">
           <label class="required">*</label></td>
          <td class="right td20"><label>开户行(支行)：</label></td>
          <td class="td30"><input type="text" name="bank_name" class="xui-validatebox" data-options="required:true">
           <label class="required">*</label></td>
        </tr>

        <tr>
          <td class="right td20"><label>户名：</label></td>
          <td class="td30"><input type="text" name="pan_name" class="xui-validatebox" data-options="required:true">
           <label class="required">*</label></td>
          <td class="right td20"><label>可退付日期：</label></td>
          <td class="td30"><input type="text" name="refund_date" class="Wdate xui-validatebox" data-options="required:true" onfocus="WdatePicker()">
           <label class="required">*</label></td>
        </tr>

        <tr>
          <td class="right td20"><label>退机原因：</label></td>
          <td class="td30  clear-readonly"><span class="xui-combobox combobox" data-options="panelHeight:'auto',editable:false,required:true,data:xConfig['cj_reason_flag']"><input type="text" class="combobox-text"><input type="hidden" name="cj_reason_flag" class="combobox-value"><span class="combobox-addon"><i class="combobox-icon combobox-arrow"></i></span></span>
           <label class="required">*</label></td>
          <td class="right td20"><label>赔付金额：</label></td>
          <td class="td30"><input type="text" name="payment_amount" class="xui-validatebox" data-options="required:true,validType:['number']">
          <label class="required">*</label></td>
        </tr>
        <tr>
          <td class="right td20"><label>备注：</label></td>
          <td class="td30"><input type="text" name="note" class="xui-validatebox" data-options=""></td>
          <td class="right td20">&nbsp;</td>
          <td class="td30">&nbsp;</td>
        </tr>
                    </tbody></table>
                </div>
	            
	            <div style="padding:5px;"></div>
            <div style="text-align:center;">
                <div style="margin:5px;"></div>
                <a href="javascript:void(0)" class="button edit xui-linkbutton l-btn" data-options="iconCls:'icon-ok',url:'/action/ms/cj-workorder/create',onSuccess:onCreateSubmitSuccess,prompt:false,datagrid:'#search-dg'" style="padding:0 5px;" onclick="xTool.addSubmit(this)"><span class="l-btn-left l-btn-icon-left"><span class="l-btn-text">提交</span><span class="l-btn-icon icon-ok">&nbsp;</span></span></a>
            	<a href="javascript:void(0)" id="return-btn" class="xui-linkbutton l-btn" data-options="iconCls:'icon-return'" style="padding:0 5px;" onclick="xTool.returnSearch(this)"><span class="l-btn-left l-btn-icon-left"><span class="l-btn-text">返回</span><span class="l-btn-icon icon-return">&nbsp;</span></span></a>
           </div>
        </form>
    </div>
    <script>

    	var myDefaultTransition = [];
    	
    	function serializeSearchForm(data) {
        	data.installed_status = ['2'];
        }
    	
    	function onLoadDetailForm(data) {
    		//linkman
    		data.data.linkman = data.data.man;
    		data.data.telno = data.data.tel_no;
    		
    		var i;
    		for(i = 0; i < data.busi_binding.length; i++) {
    			if(data.busi_binding[i].status=='1') {
    				data.data.pan = data.busi_binding[i].account_no;
    				data.data.pan_name = data.busi_binding[i].account_name;
    				data.data.bank_name = data.busi_binding[i].subbranch_name;
    			}
    		}
    		
    		data.data.cj_refund_type = '2';
    		
    		data.data.payment_amount = '0';
    		
    		$('#busi-binding-dg').datagrid('clearSelections').datagrid('loadData', data.busi_binding);
    	}
    	
    	function formatInstalledStatus(value) {
            return xTool.formatField(xConfig['installed_status'], value);
        }
        
        function formatDate(value) {
            return value.substr(0, 10);
        }
        
        function formatWorkId(value, rowData, rowIndex) {
            return xTool.formatField(xConfig['work_id'], value);
        }
        
        function formatOperIn(value, rowData, rowIndex) {
	    	return xTool.formatField(xConfig['oper_in']['A'], value);
	    }
        
        function formatProcSt(value, rowData, rowIndex) {
	    	return xTool.formatField(xConfig['proc_st']['A'], value);
	    }
	    
	    function onSuccessCreate(data) {
	    	/*
	    	
	    	xTool.send('/action/ms/term-info/list-term-busi', {
            	rec_id: data.rec_id,
            	term_no: data.term_no,
            	mcht_id: data.mcht_id
            }, function (data) {
                if (data.code == 0) {
                    $('#busi-binding-dg').datagrid('loadData', data.rows);
                }
            });
            */
	    	
	    }
	    
	    function onCreateSubmitSuccess(request, response) {
	    	$('#detail-fm').form('load', response.data);
	    	xTool.showInfo('操作成功,撤机单号'+response.data.work_order_no);
			$('#return-btn').click();
	    }
	    
	    function formatApptype(value) {
            return xTool.formatField(xConfig['apptype'], value);
        }
        
        function formatAppSt(value, row, index) {
            return xTool.formatField(xConfig['oper_in']['A'], row.oper_in) + xTool.formatField(xConfig['proc_st']['A'], row.proc_st);
        }
        
        function formatLcFeePre(value, row, index) {
        	var s = '';
        	
        	if($.inArray(row.fee_chan,['3','4']) >= 0) {
        		if(row.lc_fee_pre) {
	            	s += row.lc_fee_pre+'%';
	            	if(row.lc_fee_top) {
	            		s += '-' + row.lc_fee_top;
	            	}
	        	}
        	} else {
        		s = xTool.formatField(xConfig['fee_algo'], row.fee_rule2, 'fee_algo', 'fee_algo_name');
        	}
        	
        	return s;
        }
	    
	    function initCombobox() {
            xTool.send('/action/ms/parameter/list', {
                work_id: '1',
                fee_algo: '1'
            }, function (data) {
                if (data.code == 0) {
                    //更新
                    xConfig['work_id'] = data.work_id;
                    xConfig['fee_algo'] = data.fee_algo;
                }
            });
        }
        
        $(function(){
        	initCombobox();
        });
    </script>


</body></html>